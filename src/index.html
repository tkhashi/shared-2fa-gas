<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <script>
    const STEP = 30;
    const DATA = JSON.parse('<?= data ?>');

    let remainingSec = null;
    let timerId = null;

    function onLoad() {
      const select = document.getElementById('selector');

      // 先頭の「選択してください」以外を全部削除
      while (select.options.length > 1) {
        select.remove(1);
      }

      // サービス一覧を再構築
      if (DATA.items && Array.isArray(DATA.items)) {
        DATA.items.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.service + '/' + item.account;
          opt.textContent = item.service + ' / ' + item.account;
          select.appendChild(opt);
        });
      }

      // トークン表示
      document.getElementById('token').textContent = DATA.token || '';

      // 残り秒数の初期値（サーバ側から来た値を優先）
      if (typeof DATA.remaining === 'number' && !isNaN(DATA.remaining)) {
        remainingSec = DATA.remaining;
      } else {
        remainingSec = STEP;
      }

      // カウントダウン開始
      startCountdown();
    }

    function startCountdown() {
      const span = document.getElementById('remaining');
      if (!span) return;

      if (timerId) {
        clearInterval(timerId);
      }

      // 最初に一回反映
      span.textContent = remainingSec;

      // 1秒ごとに更新
      timerId = setInterval(() => {
        remainingSec--;
        if (remainingSec < 0) {
          // 0を過ぎたら次のスロット開始とみなしてリセット
          remainingSec = STEP;
        }
        span.textContent = remainingSec;
      }, 1000);
    }
  </script>
</head>

<body onload="onLoad()">
  <h1>Shared 2FA</h1>

  <!-- ★ここが重要：method="post" ＋ action に ScriptApp.getService().getUrl() -->
  <form method="post" action="<?= ScriptApp.getService().getUrl() ?>">
    <!-- name="entry" 1つだけ -->
    <select id="selector" name="entry">
      <option value="">選択してください</option>
    </select>

    <button type="submit">コード取得</button>
  </form>

  <h2>現在のコード</h2>
  <div id="token" style="font-size: 2em; font-family: monospace;"></div>
  <div>残り <span id="remaining"></span> 秒</div>
</body>

</html>